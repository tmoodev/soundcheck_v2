# nginx config for SoundCheck Financial
# Behind Cloudflare â€“ all public TLS handled by Cloudflare.
# nginx listens on 80 (or 443 with origin cert) and proxies to gunicorn.

# Cloudflare IP ranges (for real_ip module)
# Update periodically from https://www.cloudflare.com/ips/
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 103.21.244.0/22;
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
set_real_ip_from 141.101.64.0/18;
set_real_ip_from 108.162.192.0/18;
set_real_ip_from 190.93.240.0/20;
set_real_ip_from 188.114.96.0/20;
set_real_ip_from 197.234.240.0/22;
set_real_ip_from 198.41.128.0/17;
set_real_ip_from 162.158.0.0/15;
set_real_ip_from 104.16.0.0/13;
set_real_ip_from 104.24.0.0/14;
set_real_ip_from 172.64.0.0/13;
set_real_ip_from 131.0.72.0/22;
real_ip_header CF-Connecting-IP;

upstream soundcheck {
    server 127.0.0.1:8000;
}

server {
    listen 80;
    server_name *.soundcheckfinancial.com;

    # Security headers (Cloudflare adds some, but belt-and-suspenders)
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Static files (served by whitenoise, but nginx can cache)
    location /static/ {
        alias /home/soundcheck/soundcheck_v2/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Proxy to gunicorn
    location / {
        proxy_pass http://soundcheck;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # If using Cloudflare Full (Strict) with origin cert:
        # proxy_set_header X-Forwarded-Proto https;

        proxy_redirect off;
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;

        # Timeouts for CSV export
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;
    }

    # Deny access to dot-files
    location ~ /\. {
        deny all;
    }

    client_max_body_size 5M;
}
